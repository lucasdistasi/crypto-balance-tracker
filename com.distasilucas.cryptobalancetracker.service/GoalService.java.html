<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GoalService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">crypto-balance-tracker</a> &gt; <a href="index.source.html" class="el_package">com.distasilucas.cryptobalancetracker.service</a> &gt; <span class="el_source">GoalService.java</span></div><h1>GoalService.java</h1><pre class="source lang-java linenums">package com.distasilucas.cryptobalancetracker.service;

import com.distasilucas.cryptobalancetracker.entity.Goal;
import com.distasilucas.cryptobalancetracker.exception.DuplicatedGoalException;
import com.distasilucas.cryptobalancetracker.exception.GoalNotFoundException;
import com.distasilucas.cryptobalancetracker.model.request.goal.GoalRequest;
import com.distasilucas.cryptobalancetracker.repository.GoalRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cache.annotation.Cacheable;
import org.springframework.context.annotation.Scope;
import org.springframework.context.annotation.ScopedProxyMode;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.stereotype.Service;

import static com.distasilucas.cryptobalancetracker.constants.Constants.GOAL_CACHE;
import static com.distasilucas.cryptobalancetracker.constants.Constants.PAGE_GOALS_CACHE;
import static com.distasilucas.cryptobalancetracker.constants.ExceptionConstants.DUPLICATED_GOAL;
import static com.distasilucas.cryptobalancetracker.constants.ExceptionConstants.GOAL_ID_NOT_FOUND;
import static com.distasilucas.cryptobalancetracker.model.CacheType.GOALS_CACHES;

<span class="fc" id="L23">@Slf4j</span>
@Service
@RequiredArgsConstructor
@Scope(proxyMode = ScopedProxyMode.TARGET_CLASS)
public class GoalService {

    private final GoalRepository goalRepository;
    private final CryptoService cryptoService;
    private final CacheService cacheService;
    private final GoalService self;

    @Cacheable(cacheNames = GOAL_CACHE, key = &quot;#goalId&quot;)
    public Goal retrieveGoalById(String goalId) {
<span class="fc" id="L36">        log.info(&quot;Retrieving goal for id {}&quot;, goalId);</span>

<span class="fc" id="L38">        return goalRepository.findById(goalId)</span>
<span class="fc" id="L39">            .orElseThrow(() -&gt; new GoalNotFoundException(GOAL_ID_NOT_FOUND.formatted(goalId)));</span>
    }

    @Cacheable(cacheNames = PAGE_GOALS_CACHE, key = &quot;#page&quot;)
    public Page&lt;Goal&gt; retrieveGoalsForPage(int page) {
<span class="fc" id="L44">        log.info(&quot;Retrieving pageGoals for page {}&quot;, page);</span>
<span class="fc" id="L45">        var pageRequest = PageRequest.of(page, 10);</span>

<span class="fc" id="L47">        return goalRepository.findAll(pageRequest);</span>
    }

    public Goal saveGoal(GoalRequest goalRequest) {
<span class="fc" id="L51">        var coingeckoCrypto = cryptoService.retrieveCoingeckoCryptoInfoByNameOrId(goalRequest.cryptoName());</span>
<span class="fc" id="L52">        var existingGoal = goalRepository.findByCoingeckoCryptoId(coingeckoCrypto.id());</span>

<span class="fc bfc" id="L54" title="All 2 branches covered.">        if (existingGoal.isPresent()) {</span>
<span class="fc" id="L55">            throw new DuplicatedGoalException(DUPLICATED_GOAL.formatted(coingeckoCrypto.name()));</span>
        }

<span class="fc" id="L58">        var crypto = cryptoService.retrieveCryptoInfoById(coingeckoCrypto.id());</span>
<span class="fc" id="L59">        var goalEntity = goalRequest.toEntity(crypto);</span>
<span class="fc" id="L60">        var goal = goalRepository.save(goalEntity);</span>
<span class="fc" id="L61">        cacheService.invalidate(GOALS_CACHES);</span>

<span class="fc" id="L63">        log.info(&quot;Saved goal {}&quot;, goal);</span>

<span class="fc" id="L65">        return goal;</span>
    }

    public Goal updateGoal(String goalId, GoalRequest goalRequest) {
<span class="fc" id="L69">        var goal = self.retrieveGoalById(goalId);</span>
<span class="fc" id="L70">        var updatedGoal = goal.withNewGoalQuantity(goalRequest.goalQuantity());</span>

<span class="fc" id="L72">        log.info(&quot;Updating goal. Before: {} | After: {}&quot;, goal, updatedGoal);</span>
<span class="fc" id="L73">        var goalUpdated = goalRepository.save(updatedGoal);</span>
<span class="fc" id="L74">        cacheService.invalidate(GOALS_CACHES);</span>

<span class="fc" id="L76">        return goalUpdated;</span>
    }

    public void deleteGoal(String goalId) {
<span class="fc" id="L80">        var goal = self.retrieveGoalById(goalId);</span>

<span class="fc" id="L82">        goalRepository.deleteById(goalId);</span>
<span class="fc" id="L83">        cryptoService.deleteCryptoIfNotUsed(goal.getCrypto().getId());</span>
<span class="fc" id="L84">        cacheService.invalidate(GOALS_CACHES);</span>

<span class="fc" id="L86">        log.info(&quot;Deleted goal {}&quot;, goal);</span>
<span class="fc" id="L87">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>